<product-recommendations
  class="product-recommendations"
  data-url="{{ routes.product_recommendations_url }}?section_id={{ section.id }}&product_id={{ product.id }}&limit=8&intent=related"
>
  {%- if recommendations.performed and recommendations.products_count > 0 -%}
    <div class="product-recommendations__container">
      <h2 class="product-recommendations__title">You may also like</h2>

      <div class="product-recommendations__slider-wrapper">
        <div class="swiper product-recommendations__swiper">
          <div class="swiper-wrapper">
            {%- for product in recommendations.products -%}
              <div class="swiper-slide">
                <div class="product-card">
                  <a href="{{ product.url }}" class="product-card__link">
                    <div class="product-card__image-wrapper">
                      <img
                        class="product-card__image"
                        src="{{ product.featured_image | image_url: width: 600 }}"
                        alt="{{ product.featured_image.alt | escape }}"
                        loading="lazy"
                        width="312"
                        height="312"
                      >
                    </div>

                    <p class="product-card__title">{{ product.title }}</p>
                    <p class="product-card__price">{{ product.price | money }}</p>
                  </a>
                </div>
              </div>
            {%- endfor -%}
          </div>
        </div>

        <button type="button" class="product-recommendations__arrow product-recommendations__arrow--prev" aria-label="Previous">
          {{ 'left-arrow.svg' | asset_url | img_tag: '', loading: 'lazy', width: 40, height: 40 }}
        </button>

        <button type="button" class="product-recommendations__arrow product-recommendations__arrow--next" aria-label="Next">
          {{ 'right-arrow.svg' | asset_url | img_tag: '', loading: 'lazy', width: 40, height: 40 }}
        </button>
      </div>
    </div>
  {%- endif -%}
</product-recommendations>

<script>
  class ProductRecommendations extends HTMLElement {
    constructor() {
      super();
      this.productHandle = null;
      this.swiper = null;
    }

    connectedCallback() {
      this.loadRecommendations();
      this.initSwiper();

      // Listen for product changes
      document.addEventListener('product:changed', (e) => {
        this.productHandle = e.detail.productHandle;
        this.loadRecommendations();
      });
    }

    initSwiper() {
      // Wait for Swiper to be available
      if (typeof Swiper === 'undefined') {
        setTimeout(() => this.initSwiper(), 100);
        return;
      }

      const swiperEl = this.querySelector('.product-recommendations__swiper');
      if (!swiperEl) return;

      // Destroy existing swiper if it exists
      if (this.swiper) {
        this.swiper.destroy(true, true);
      }

      this.swiper = new Swiper(swiperEl, {
        slidesPerView: 'auto',
        spaceBetween: 16,
        freeMode: true,
        navigation: {
          prevEl: this.querySelector('.product-recommendations__arrow--prev'),
          nextEl: this.querySelector('.product-recommendations__arrow--next'),
        },
        breakpoints: {
          1024: {
            spaceBetween: 24,
          },
        },
      });
    }

    async loadRecommendations() {
      let url = this.dataset.url;

      // If product was changed, update URL with new product handle
      if (this.productHandle) {
        const productId = await this.getProductIdFromHandle(this.productHandle);
        if (productId) {
          const urlObj = new URL(url, window.location.origin);
          urlObj.searchParams.set('product_id', productId);
          url = urlObj.toString();
        }
      }

      fetch(url)
        .then((response) => response.text())
        .then((text) => {
          const html = document.createElement('div');
          html.innerHTML = text;
          const recommendations = html.querySelector('product-recommendations');

          if (recommendations && recommendations.innerHTML.trim().length) {
            this.innerHTML = recommendations.innerHTML;
            // Re-initialize Swiper after content update
            this.initSwiper();
          }
        })
        .catch((e) => {
          console.error(e);
        });
    }

    async getProductIdFromHandle(handle) {
      try {
        const response = await fetch(`/products/${handle}.js`);
        const product = await response.json();
        return product.id;
      } catch (error) {
        console.error('Error fetching product ID:', error);
        return null;
      }
    }
  }

  customElements.define('product-recommendations', ProductRecommendations);
</script>

{% schema %}
{
  "name": "Product recommendations",
  "tag": "section",
  "class": "product-recommendations-section",
  "settings": [],
  "presets": [
    {
      "name": "product-recommendations"
    }
  ]
}
{% endschema %}
